#!/usr/bin/env python
# coding: utf-8

# # Project 2
# Name: Janhavi Agarwal       
# Student number: 1005786534

# In[2]:


#! pip install qeds fiona geopandas xgboost gensim folium pyLDAVIS descartes


# In[2]:


import geopandas as gpd
import matplotlib.pyplot as plt
import pandas as pd
import numpy as np
import statsmodels.formula.api as sm 

from shapely.geometry import Point 

get_ipython().run_line_magic('matplotlib', 'inline')
import qeds
qeds.themes.mpl_style();
import warnings
warnings.filterwarnings('ignore')


# ## Project 1

# ### (Part 1)

# ### Introduction 
# 
# 2020 saw the killing of George Floyd and the subsequent spark in the #BlackLivesMatter movement. This brought to the surface the fact that race plays a big role in determining the day to day in the United States of America. In this paper, I have analyzed the share of White and POC population across counties in the USA and the share of Republican voters in those counties. 
# 
# The X variable I have chosen is "Share of White Population" and the Y variable I have chosen is "Republican share". 
# 
# In this project, I first clean the data, then I plot histograms, a scatterplot and a map showing the Republican voting across the US states. 

# ### Data Cleaning Process

# In[3]:


county_characteristics = pd.read_csv("/Users/janhavi/Desktop/eco225/project1/usa-2016-presidential-election-by-county.csv", sep = ';')
county_characteristics.head()


# Since I want to focus on the particular characteristic of race, I will focus on these columns and drop the rest. 

# In[4]:


county_races = county_characteristics [["State", "County", "Votes", "Republicans 2016", 
                                          "Democrats 2016", "White (Not Latino) Population", "African American Population", 
                                          "Native American Population", "Asian American Population", "Other Race or Races", 
                                          "Latino Population"]]
county_races["Other races"] = 100 - county_races["White (Not Latino) Population"]
county_races.head()


# In[5]:


county_races = county_races[["State", "County", "Votes", "Republicans 2016", "Democrats 2016", 
                                "White (Not Latino) Population", "Other races"]]
county_races.rename(columns = {"White (Not Latino) Population": "White"}, inplace=True)
county_races.head()


# #### Plotting a Histogram for the X-variable

# In[6]:


county_races = county_races.dropna()
fig, ax = plt.subplots()
county_races.plot(kind="hist", y="Republicans 2016", color = (244/255, 77/255, 24/255),
                    bins = 100, legend = False, density=True, ax=ax)
ax.set_xlabel("Percentage of Republican votes")
ax.set_title("Histogram describing distribution of Republican voting percentages")
ax.spines['right'].set_visible(False)
ax.spines['top'].set_visible(False)


# The purpose of this Histogram is to see whether there is a skew in the trend for Republican voting percentage by county. We see that the data is a bit left skewed, but not by that much. 

# #### Plotting the Histogram for the Y-variable

# In[7]:


fig, ax = plt.subplots()
county_races.plot(kind="hist", y="White", color=(244/255, 77/255, 24/255), 
                    bins = 100, legend=False, density=True, ax=ax)

ax.set_xlabel("Percentage of county population that is White")
ax.set_title("Histogram describing distribution of White Population")
ax.spines['right'].set_visible(False)
ax.spines['top'].set_visible(False)


# We see that the data is heavily left skewed. Most counties have a high white population

# ## Project 2

# ### Part 2

# #### The Message 

# There is a positive relationship between counties with a higher White population and their share of Republican voters, ie, a county that has a higher White population is more likely to have a higher share of Republican voters and vice versa. 

# #### Drafting a Scatterplot

# In[8]:


fig, ax = plt.subplots()
county_races.plot(kind="scatter", x="White", y="Republicans 2016", ax=ax)

plt.show()


# The scatterplot is does show a positive correlation but it is messy and unrefined. I will make it more attractive and readable through some adjustments, and I will add a regression line through it to show a more interpretable correlation. 

# #### Fine-tuning the Scatterplot

# In[9]:


from sklearn.linear_model import LinearRegression

fig, ax = plt.subplots()
county_races.plot(kind="scatter", x="White", y="Republicans 2016", ax=ax, color='red')

lr = LinearRegression()
X = county_races["White"].values.reshape(-1,1)
Y = county_races["Republicans 2016"].values.reshape(-1,1)
lr.fit(X,Y)

x = np.linspace(0.0, 100.0).reshape(-1,1)
y_pred = lr.predict(x)
ax.plot(x, y_pred, color='blue')

ax.set_ylim(0,100)
ax.spines['top'].set_visible(False)
ax.spines['right'].set_visible(False)
ax.set_title('Share of White Population compared with Share of Republican voters')
ax.set_ylabel("Share of Republican voters")
ax.set_xlabel("Share of White Population")

plt.show()


# The regression line shows that there is a positive trend between share of White Population in a county and the share of Republican voters in that state. 

# ### Part 3

# I now read a shapefile containing the states of the US along with their geometries so that I can plot the respective states and their share of Republican voters. I work with states instead of counties here since they are easier to visualize and cause less clutter in the map. 

# In[10]:


us_states = gpd.read_file('/Users/janhavi/Downloads/tl_2017_us_state/tl_2017_us_state.shp')
us_states_mainland = us_states.drop([31, 34, 35, 36, 41, 49, 40])
us_states_mainland.head()


# I now create a DataFrame to show the percentage of Republican voters in each state. 

# In[12]:


states_republicans = county_races.groupby("State")["Republicans 2016"].mean().reset_index()
states_republicans.sort_values("Republicans 2016", ascending = True).reset_index().drop(columns = "index").head()
states_republicans.head()


# I will now merge this DataFrame with the GeoDataFrame to create a new GeoDataFrame called 'maps_states_republicans'. I will create my map from this. 

# In[15]:


maps_states_republicans = us_states_mainland.merge(states_republicans, left_on='NAME', right_on='State', how='inner')
maps_states_republicans = maps_states_republicans.rename(columns = {"Republicans 2016" : "republicans_2016"})
maps_states_republicans.head()


# In[44]:


# Creating the map 

fig, gax = plt.subplots(figsize=(15,15))

us_states_mainland.plot(ax=gax, edgecolor='black', color='white')

maps_states_republicans.plot(
    ax=gax, edgecolor='black', column='republicans_2016', legend=True, cmap='RdBu_r',
)
gax.annotate('Percent of Republican voters',xy=(0.73, 0.06),  xycoords='figure fraction')

plt.axis('off')

plt.show()


# The plot tells us that the highest concentration of Republicam voters are in the Southern and central states. States with higher Democrat voters are in the Eastern most points of the country. We will see if this corresponds to states with a higher White population which I will display using a bar plot. 

# In[26]:


maps_states_republicans = maps_states_republicans.set_index('NAME')
maps_states_republicans.head()


# In[33]:


fig,ax = plt.subplots(figsize=(20,20))

maps_states_republicans["republicans_2016"].plot(kind='bar', ax=ax)

ax.set_title("Republican share of voters among the US States")
ax.set_xlabel("State")
ax.set_ylabel("Percentage of Republican Voters")


# Comparing with the DataFrame and the map, we see that the states with higher White population have higher share of Republican voters. 

# #### Adding Interactivity to the map

# In[36]:


#! pip install bokeh

from bokeh.io import output_notebook
from bokeh.plotting import figure, ColumnDataSource
from bokeh.io import output_notebook, show, output_file
from bokeh.plotting import figure
from bokeh.models import GeoJSONDataSource, LinearColorMapper, ColorBar, HoverTool
from bokeh.palettes import brewer
output_notebook()
import json
#Convert data to geojson for bokeh
wi_geojson=GeoJSONDataSource(geojson=maps_states_republicans.to_json())


# In[42]:


color_mapper = LinearColorMapper(palette = brewer['RdBu'][10], low = 0, high = 100)
color_bar = ColorBar(color_mapper=color_mapper, label_standoff=8,width = 500, height = 20,
                     border_line_color=None,location = (0,0), orientation = 'horizontal')
hover = HoverTool(tooltips = [ ('State','@State'),('Republican Share', '@republicans_2016'),
                               ])
p = figure(title="Republican Voting in 2016 Presidential Election", tools=[hover])
p.patches("xs","ys",source=wi_geojson,
          fill_color = {'field' :'republicans_2016', 'transform' : color_mapper})
p.add_layout(color_bar, 'below')
show(p)


# A link to the HTML to see the interactive map: file:///Users/janhavi/Downloads/agarwal_janhavi_project2.html

# ## Conclusion
# 
# My hypothesis that counties with higher White population tend to have a higher share of Republican voters was further proven right. I further explored this using maps and a scatterplot which had a regression line. 

# In[ ]:




